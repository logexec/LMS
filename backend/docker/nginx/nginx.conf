server {
  listen 80;
  server_name 10.120.1.20;

  root /var/www/html/public;
  index index.php index.html;

  # —————— Preflight y API normal ——————
  location ^~ /api/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin  "http://10.120.1.20:3000" always;
      add_header Access-Control-Allow-Credentials "true"               always;
      add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
      add_header Access-Control-Allow-Headers     "Content-Type, Accept, Authorization, X-Requested-With, X-XSRF-TOKEN" always;
      return 204;
    }

    # respuestas de PHP-FPM
    proxy_pass http://backend:9000;  # o fastcgi_pass si usas php-fpm
    # …la configuración fastcgi o proxy normal…
    add_header Access-Control-Allow-Origin  "http://10.120.1.20:3000" always;
    add_header Access-Control-Allow-Credentials "true"               always;
    add_header Access-Control-Allow-Methods     "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers     "Content-Type, Accept, Authorization, X-Requested-With, X-XSRF-TOKEN" always;
  }

  location / {
    try_files $uri $uri/ /index.php?$query_string;
  }

  location ~ \.php$ {
    fastcgi_pass   backend:9000;
    include        fastcgi_params;
    fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
  }
}
